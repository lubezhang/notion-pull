# Notion 全量导出工具需求说明

## 背景
- 团队使用 Notion 作为知识库，需定期备份到本地文件系统。
- 现有导出流程需要手动操作，步骤繁琐且缺乏自动化。

## 目标
- 提供一款基于 Node.js 的命令行工具，自动化导出全部 Notion 页面为 Markdown 文件，并同步下载页面中的媒体资源。
- 生成的目录结构清晰可控，支持二次加工或同步到版本控制仓库。

## 用户与场景
- **备份维护者**：定期运行导出命令，将数据备份到指定文件夹或 Git 仓库。
- **知识复用者**：在本地阅读 Markdown 版本的 Notion 内容，可离线查阅。

## 项目范围
- **包含**：
  - 使用 Notion 官方 API，通过集成 Token 访问指定的 Workspace 或根页面下的全部子页面。
  - 按页面构建 Markdown 文件，保留标题层级、富文本、列表、待办、代码块等格式。
  - 在与 Markdown 文件同级的 `img/` 目录保存图片及文件类型资源，并更新 Markdown 中的引用路径。
  - 支持导出数据库（collection）内容，以 Markdown 表格或列表形式呈现。
  - 支持增量导出：重复执行时能够跳过未变化页面或覆盖已有文件。
  - 提供基础命令行参数配置输出目录、根页面 ID、并发度等。
  - 记录导出日志，至少包含成功页面、跳过页面、失败页面的统计。
- **不包含**（后续版本可能支持）：
  - Web UI 界面或计划任务调度。
  - Notion 双向同步或增量回写。
  - 评论、用户权限、分享链接等非页面内容。

## 详细需求
1. **认证配置**
   - 默认从环境变量 `NOTION_TOKEN` 读取集成 Token。
   - 支持通过 CLI 参数显式传入 Token。
   - Token 缺失时应给出友好提示并退出。
2. **页面范围选择**
   - 支持配置根页面 ID；若未指定，则导出整个集成有权限访问的所有顶层页面。
   - 对于嵌套页面需深度遍历，保留 Notion 原有层级结构。
3. **Markdown 导出**
   - 标题、段落、列表、引用、代码块、公式等常见块需正确转换。
   - 数据库支持两种导出策略：生成单独 Markdown 文件或在父页面内嵌表格，需在设计中选型。
   - 支持保留块的属性（例如待办勾选状态）。
   - 文件命名默认使用页面标题（处理非法字符及重名冲突），可配置生成 slug。
4. **资源下载**
   - 下载图片、文件、音视频等资源至对应该页面的 `img/` 子目录。
   - Markdown 内引用使用相对路径（例如 `./img/image.png`）。
   - 对于外链或无法下载的资源应在日志中提示并保留原始链接。
5. **输出结构**
   - 默认输出路径为执行目录下的 `export/`。
   - 页面层级映射为文件夹层级，顶层页面对应一级目录。
   - 提供选项控制是否合并所有页面到单一目录。
6. **错误处理与日志**
   - 对于 API 调用失败、权限不足、下载失败等情况记录详细错误信息。
   - 运行结束输出汇总，包括总页面数、成功、失败、跳过数量。
7. **性能与重试**
   - 支持配置并发度，以避免触发 Notion API 限流。
   - 对于限流响应或临时错误，至少重试三次（指数退避）。

## 非功能性需求
- **可维护性**：代码模块化，具备单元测试覆盖核心转换逻辑。
- **兼容性**：要求 Node.js 18 LTS 及以上版本。
- **可扩展性**：预留插件或策略接口，方便未来扩展导出格式。
- **安全性**：避免在日志中打印 Token 等敏感信息。

## 输出成果
- 一次导出生成的 Markdown 文件与资源文件，与 Notion 原有层级结构一致。
- 生成导出报告（可为 JSON 或纯文本），作为命令行输出或单独文件存档。
- 编写 README，说明安装、配置及使用步骤（后续任务实现）。

## 验收标准
- 在测试工作区成功导出至少一个包含嵌套页面、数据库、图片的 Notion 页面集合。
- Markdown 文件内容结构清晰，无明显格式丢失。
- 图片资源全部保存在对应页面的 `img/` 目录并能正常引用。
- 连续运行多次不会因文件冲突导致失败，可通过配置控制覆盖策略。
